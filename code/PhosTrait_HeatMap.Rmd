title: "Phosphorus Traits"
author: "Jay T. Lennon, Mario Muscarella, Kali Bird"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
  - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

Generalist and specialist strategies of phosphorus acquistion by aquatic bacteria 

```{r}
rm(list=ls())
getwd()
setwd("~/GitHub/PhosTrait")
```

Load package for writing figures
```{r}
require("png")
require("vegan")
require("pvclust")
require("gplots")
require("gridGraphics")
require("grid")
require("gplots")
require("gridExtra")
```

Load data (note this is raw growth rates; not phylogenetically correct)
```{r}
setwd("~/GitHub/PhosTrait")
gr.data <- read.csv("data/grraw.csv", sep=",", header=TRUE)
str(gr.data)
colnames(gr.data)[1]<-"isolate"

# Data standardizing - log10 tranformation
log.gr <- log10(gr.data[,2:19]+1)

# Data standardizing - divide by sum of species growth
gr.std <- gr.data[,2:19] / (apply(gr.data[,2:19], 1, sum))
```

Customize Color Palette
```{r}
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", 
                                 "#7FFF7F", "yellow", "#FF7F00", "red", 
                                 "#7F0000"))

gray.colors <- gray.colors(25, start = 0.9, end = 0.1, gamma = 1.5, alpha = 1)
```

Randomize growth rate data and make heatmap
```{r}
set.seed(4672)
rand.row <- log.gr[sample(nrow(log.gr)),]
set.seed(9764)
rand.row2 <-log.gr[sample(nrow(log.gr)),]
set.seed(9863)
rand.col <- rand.row[sample(ncol(rand.row))]
rand.gr.std <- rand.col
rand.heat <- heatmap.2(as.matrix(rand.gr.std), distfun = function(x) 
          vegdist(x, method = "bray"),
          hclustfun = function(x) hclust(x, method = "ward.D2"), 
          col = gray.colors, trace = "none", density.info = "none")
```

Calculate column-wise growth rate data (mean and sd) and make heatmap
```{r}
col.means <-colMeans(log.gr)
col.sd <- apply(log.gr, 2, sd)
col.wise <- mapply(rnorm, nrow(log.gr), col.means, col.sd/30)
colnames(col.wise) <- colnames(log.gr)
col.heat <- heatmap.2(as.matrix(col.wise), distfun = function(x) 
          vegdist(x, method = "bray"),
          hclustfun = function(x) hclust(x, method = "ward.D2"), 
          col = gray.colors, trace = "none", density.info = "none")
```

Calculate row-wise growth rate data (mean and sd) and make heatmap
```{r}
row.means <-rowMeans(log.gr)
row.sd <- apply(log.gr, 1, sd)
row.wise <- t(mapply(rnorm,ncol(log.gr), row.means, row.sd/10))
colnames(row.wise) <- colnames(log.gr)
row.heat <- heatmap.2(as.matrix(row.wise), distfun = function(x) 
          vegdist(x, method = "bray"),
          hclustfun = function(x) hclust(x, method = "ward.D2"), 
          col = gray.colors, trace = "none", density.info = "none")
```

Actual growth rate data as heatmap
```{r}
actual.heat <- heatmap.2(as.matrix(gr.std), distfun = function(x) 
          vegdist(x, method = "bray"), hclustfun = function(x) 
          hclust(x, method = "ward.D2"), col = gray.colors, trace = "none", 
          density.info = "none")
```

Make multipanel heatmap
```{r}
# Generation instructions for approach here: http://stackoverflow.com/questions/13081310/combining-multiple-complex-plots-as-panels-in-a-single-figure

# Make a list of dataframes for each scenario
heat.list <- list(rand.gr.std, col.wise, row.wise, gr.std)

# Vector of names for P resources
resources <- colnames(row.wise)

# Function for running through list
grab_grob <- function(){
  grid.echo()
  grid.grab()
}

gl <- lapply(1:4, function(i){
  heatmap.2(as.matrix(heat.list[[i]]), dendrogram = 'row',
            Colv = FALSE, col = jet.colors, 
            key = FALSE, keysize = 1.0, symkey = FALSE, density.info = 'none',
            trace = 'none', colsep = 1:10,
            sepcolor = 'white', sepwidth = 0.05,
            scale = "none", cexRow = 1.5, cexCol = 1.5,
            labCol = resources,                 
            hclustfun = function(c){hclust(c, method='mcquitty')},
            lmat = rbind( c(0, 3), c(2,1), c(0,4) ), lhei = c(0.25, 4, 0.25 ),                 
  )
  grab_grob()
})

png(filename="~/GitHub/PhosTrait/figures/HeatMap.png", width = 2400, 
    height = 2400, res = 96*2)

grid.newpage()
grid.arrange(grobs = gl, ncol = 2, clip = TRUE)

dev.off()
graphics.off()
```