title: "Phosphorus Traits"
author: "Jay T. Lennon, Mario Muscarella, Kali Bird"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
  - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

Overview: make heatmaps with our data to visualize use of different phosphorus (P) sources by bacteria from an oligotrophic lake (Little Long) and eutrophic lake (Wintergreen Lake). First panel (upper left) randomizes the the data by row and column. Second panel (upper right) randomizes so that there's no difference among strains. Third panel (lower left) randomizes so that there's no difference among P sources. Fourth panel (lower right) is the observed data. 

# Set working directory
```{r}
rm(list=ls())
getwd()
setwd("~/GitHub/PhosTrait")
```

# Load packages
```{r}
require("png")
require("vegan")
require("pvclust")
require("gplots")
require("gridGraphics")
require("grid")
require("gplots")
require("gridExtra")
```

# Load data 
```{r}
# Raw growth rate data
gr.data <- read.csv("data/grraw.csv", sep=",", header=TRUE)
str(gr.data)
colnames(gr.data)[1]<-"isolate"

# Data standardizing - log10 tranformation
log.gr <- log10(gr.data[,2:19]+1)

# Data standardizing - divide by sum of species growth
gr.std <- gr.data[,2:19] / (apply(gr.data[,2:19], 1, sum))

# Names
resources <- colnames(gr.data[,2:19])
strains <- gr.data[,1]
```

# Customize color palette
```{r}
# This website is useful for generating colors: http://colorbrewer2.org/#type=sequential&scheme=Reds&n=8

jet.col <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", 
                                 "#7FFF7F", "yellow", "#FF7F00", "red", 
                                 "#7F0000"))

gray.col <- gray.colors(25, start = 0.9, end = 0.1, gamma = 1.5, alpha = 1)

yelred.col <- colorRampPalette(c("yellow","orange", "red"))

green.col <- colorRampPalette(c("#e5f5e0", "#c7e9c0", "#a1d99b", 
                        "#74c476", "#41ab5d", "#238b45", "#00441b"))

colors <- green.col
```

# Clustering parameters
```{r}
distance <- "euclidean" 
    # others to consider: manhattan, correlation, uncentered,
    # abscor, euclidean, bray

# Identify agglomerative method
clust <- "average"   
    # others to consider:
    # complete = furthest neighbor; compact clusters, sensitive to outliers
    # average = UPGMA; considered robust
    # ward.D = popular, but makes clusters of equal size, sensitive to outliers
    # ward.D2 = dissimilarities are squared before clustering
    # mcquitty
    # median = downweights outliers
    # centroid = fairly robust
    # single = nearest neighbor; chaining problem
```

# Create four data sets for plotting
```{r}
# 1) Randomize growth rate data
log.gr.mat <- as.matrix(log.gr)
colnames(log.gr.mat) <- colnames(gr.data[,2:19])
rownames(log.gr.mat) <- gr.data[,1]
rand <- matrix(sample(log.gr.mat), nrow = nrow(log.gr))

# 2) Randomize by strain holding resource constant 
# That is, simluate differenes among resources

# Calculate column means
col.means <-colMeans(log.gr)

# Calculate standard deviation of columns
col.sd <- apply(log.gr, 2, sd)

# Create dataframe with mean column and sd
col.wise <- mapply(rnorm, nrow(log.gr), col.means, col.sd/30)
colnames(col.wise) <- resources

# 3. Randomize by resource holding strain constant 
# That is, simluate differenes among strains

# Calculate row means
row.means <-rowMeans(log.gr)

# Calculate standard deviation of rows
row.sd <- apply(log.gr, 1, sd)

# Create dataframe with mean rows and sd
row.wise <- t(mapply(rnorm,ncol(log.gr), row.means, row.sd/30))
colnames(row.wise) <- colnames(log.gr)
```

# Make multipanel heatmap
```{r}
# Example: http://stackoverflow.com/questions/13081310/combining-multiple-complex-plots-as-panels-in-a-single-figure

# Make a list of dataframes for each scenario
heat.list <- list(rand, col.wise, row.wise, log.gr)

# Function for running through list
grab_grob <- function(){
  grid.echo()
  grid.grab()
}

gl <- lapply(1:4, function(i){
  heatmap.2(as.matrix(heat.list[[i]]), distfun = function(x) 
          vegdist(x, method = distance), hclustfun = function(x) 
          hclust(x, method = clust), key = FALSE, keysize = 1,
          key.title = NA, key.xlab = NA, col = colors, trace = "none", 
          density.info = "none", labRow = strains, 
          labCol = resources, symkey = FALSE, 
          colsep = 1:16, rowsep = 1:37, sepcolor = "white",
          scale = "none", cexRow = 1, cexCol = 1, margins = c(6,6),
          lmat = rbind( c(0, 3), c(2,1), c(0,4) ), lhei = c(0.25, 4, 0.25 ),                 
  )
  grab_grob()
})

png(filename="~/GitHub/PhosTrait/figures/HeatMap.png", width = 2400, 
    height = 2400, res = 96*2)

grid.newpage()
grid.arrange(grobs = gl, ncol = 2, clip = TRUE)

dev.off()
graphics.off()
```
