title: "Phosphorus Traits"
author: "Jay T. Lennon, Mario Muscarella, Kali Bird"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
  - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

Generalist and specialist strategies of phosphorus acquistion by aquatic bacteria 
# Set working directory
```{r}
rm(list=ls())
getwd()
setwd("~/GitHub/PhosTrait")
```

# Load packages
```{r}
require("png")
require("grid")
require("vegan")
require("phylolm")
require("muscle")
require("seqinr")
require("ape")
```

# Load data
```{r}
gr.data <- read.csv("data/grraw.csv", sep=",", header = TRUE, row.names = 1)
str(gr.data)

# Standadize Growth Rates Across Strains
gr.std <- gr.data / (apply(gr.data, 1, sum))

# Calculate Max Growth Rate
umax <- as.matrix((apply(gr.data, 1, max))) 

umax2 <- as.matrix((apply(gr.std, 1, max))) 
srp <- gr.data$SRP

round(apply(gr.std, 2, max), 4)
round(apply(gr.std, 2, min), 4)

plot(log10(umax) ~ log10(srp))
abline(0, 1)
```

# Niche breadth (Levins 1968)
```{r}
levins <- function(p_xi = ""){
  p = 0
  for (i in p_xi){
    p = p + i^2
    }
  nb = 1 / (length(p_xi) * p)
  return(nb)
  }

# Calculate niche breadth for Each Isolate
nb <- as.matrix(levins(gr.std))

# Add Row & Column Names to Niche Breadth Matrix
rownames(nb) <- rownames(gr.data)
colnames(nb) <- c("nb")
```  

# Build a `phylo` file
```{r}
# Load Maximum Likielihood Tree File
ml.bootstrap <- read.tree("./data/RAxML_bestTree.LTDE.ML")

# Identify Outgroup Sequence
outgroup <- match("Methanosarcina", ml.bootstrap$tip.label)

# Root the Tree {ape}
ml.rooted <- root(ml.bootstrap, outgroup, resolve.root = TRUE)

# Plot the Rooted Tree{ape}
par(mar = c(1,1,2,1) + 0.1)
plot.phylo(ml.rooted, main = "ML", "phylogram", 
           use.edge.length = FALSE, direction = "right", cex = 0.6, 
           label.offset = 1)
add.scale.bar(cex = 0.7)

# Keep Rooted but Drop Outgroup Branch
p.tree <- drop.tip(ml.rooted, "Methanosarcina")
```

# Phylogenetic regression (simple w/o dummy variable)
```{r}
taxa <- sort(p.tree$tip.label)
dat <- data.frame(umax, nb, srp)
fit <- phylolm(log10(umax) ~ nb, data = dat, phy = p.tree, model = "lambda")
summary(fit)

fit <- phylolm(log10(srp) ~ nb, data = dat, phy = p.tree, model = "lambda")
summary(fit)
```

# Phylogenetic multiple regression
```{r}
lake <- ifelse(grepl("WG",row.names(gr.data)),'WG', 'LL') # make an empty vector for lake id
tradeoff <- data.frame(nb, umax, lake, srp) # make new data frame
D <- (lake == "LL") * 1

fit <- phylolm(log10(tradeoff$umax) ~ tradeoff$nb + D + tradeoff$nb * D, data = tradeoff, 
        phy = p.tree, model = "lambda")
summary(fit)

```

# Plot trade-off with phylo-corrected parameters
```{r}
# Subset umax data to plot
  LL.nb <- subset(nb, lake == "LL")
  WG.nb <- subset(nb, lake == "WG")

# Subset niche breadth data to plot
  LL.umax <- subset(umax, lake == "LL")
  WG.umax<-subset(umax, lake == "WG")

# Initiate file for figure
png(filename="~/GitHub/PhosTrait/figures/Tradeoff.png",
    width = 1200, height = 1200, res = 96*2)

# Set plotting dimensions
  par(mar=c(4,4,0,1)+ 0.1)

# Little Long points
  plot(LL.nb, log10(LL.umax), axes = F, xlab = "Niche Breadth", ylab = "Maximum Growth Rate", 
  pch = 21, cex = 2.0, las = 1, col = "black", bg = "white",
  xlim=c(0,1), ylim = c(-2, 1), lwd = 1.5)

# Wintergreen points
  points(WG.nb, log10(WG.umax), pch = 21, cex = 2, col = "black", bg = "black")
  
# Format axes
  box(lwd = 2)
  ticks <- c(0.01, 0.1, 1, 10)
  axis(side = 1, labels = T, cex.axis = 1)
  axis(side = 2, las = 1, cex.axis = 1, labels = ticks,
    at = log10(ticks))
  axis(3, labels = F)
  axis(side = 4, at = log10(ticks), labels = F)

# Plot WG regression lines
  curve(fit$coefficients[1] + fit$coefficients[2] * x, from = min(WG.nb - 0.1), 
  to = max(WG.nb +0.1), add = TRUE, lty = 3, lwd = 2)

# Plot LL regression lines
  Int <- fit$coefficients[1] + fit$coefficients[3]
  Slp <- fit$coefficients[2] + fit$coefficients[4]
  curve((Int) + (Slp) * x, from = min(LL.nb - 0.08), to = max(LL.nb + 0.1), 
      add = TRUE, lty = 2, lwd = 2)

legend("topleft", legend = c("LL","WG"), pch = c(1, 16), cex = 1, 
       col = "black", bty = "n", pt.cex = 2)

dev.off()
graphics.off() # shuts down open devices
```

```{r fig.width=4, fig.height=4,echo=FALSE}
img <- readPNG("./figures/Tradeoff.png")
grid.raster(img)
```

```{r}
fit <- phylolm(log10(umax) ~ nb*D, data = tradeoff, 
        phy = p.tree, model = "lambda")
summary(fit)

fit <- phylolm(log10(umax) ~ nb, data = tradeoff[tradeoff$lake == "LL", ], 
               phy = drop.tip(p.tree, row.names(tradeoff)[which(tradeoff$lake != "LL")]), 
               model = "lambda")
summary(fit)

fit <- phylolm(log10(umax) ~ nb, data = tradeoff[tradeoff$lake == "WG", ], 
               phy = drop.tip(p.tree, row.names(tradeoff)[which(tradeoff$lake != "WG")]), 
               model = "lambda")
summary(fit)



```

